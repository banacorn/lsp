# modified from https://github.com/simonmichael/hledger/blob/master/.github/workflows/windows.yml

name: Haskell CI - Stack (Windows)

on: [push, pull_request]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        # use this to specify what resolvers and ghc to use
        stack-yaml: 
          # - "--stack-yaml=stack-8.4.4.yaml"
          # - "--stack-yaml=stack-8.6.5.yaml"
          # - "--stack-yaml=stack-8.8.4.yaml"
          - "--stack-yaml=stack-8.10.4.yaml"

    runs-on: ${{ matrix.os }}
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v2

    - name: ‚è¨ Install stack
      #if: steps.stack-programs-dir.outputs.cache-hit != 'true'
      # this step is needed to get stack.exe into PATH, for now
      run: |
        curl -sL https://get.haskellstack.org/stable/windows-x86_64.zip -o stack.zip
        7z x stack.zip stack.exe
        which stack
        stack --version
        which ./stack
        ./stack --version

    - name: ‚è¨ Install GHC
      # if: steps.stack-programs-dir.outputs.cache-hit != 'true'
      # set PATH=C:\Users\runneradmin\AppData\Local\Programs\stack\local\bin;%PATH%
      run: |
        ./stack --no-terminal $ARGS setup --install-ghc
      env:
        ARGS: ${{ matrix.stack-yaml }}

    - name: üì∏ Build Snapshot
      run: |
        ./stack --no-terminal $ARGS build --bench --only-snapshot
      env:
        ARGS: ${{ matrix.stack-yaml }}

    - name: üß∞ Build Dependencies
      run: |
        ./stack --no-terminal $ARGS build --only-dependencies
      env:
        ARGS: ${{ matrix.stack-yaml }}